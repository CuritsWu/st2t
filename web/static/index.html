<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <!-- <title>Realtime Caption</title> -->
    <style>
        /* ---------- é…è‰² ---------- */
        body {
            background: #fff;
            color: #000;
            font: 20px/1.6 monospace;
            text-align: center
        }

        #caption {
            margin-top: 30vh;
            font-size: 2.5rem;
            word-break: break-all;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>ğŸ™ï¸ Realtime Caption</h1>
    <div id="caption">(ç­‰å¾…éº¥å…‹é¢¨æˆæ¬Šâ€¦)</div>

    <script>
        (async () => {
            /* --------- è‡ªå‹•åŸ·è¡Œ --------- */
            const SAMPLE_RATE = 16000;

            /* 1. é€£å­—å¹• WebSocket */
            const capWS = new WebSocket(`wss://${location.host}/ws/caption`);
            capWS.onmessage = e => {
                document.getElementById('caption').textContent = e.data || 'â€¦';
            };

            /* 2. å–éº¥å…‹é¢¨ */
            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            } catch (err) {
                document.getElementById('caption').textContent = 'ğŸ’¥ ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼š' + err.message;
                return;
            }

            /* 3. å»ºç«‹ AudioWorklet â†’ é€éŸ³è¨Š */
            const ctx = new AudioContext();
            await ctx.audioWorklet.addModule('/static/worklet.js');
            const source = ctx.createMediaStreamSource(stream);
            const processor = new AudioWorkletNode(ctx, 'pcm-writer');

            const audioWS = new WebSocket(`wss://${location.host}/ws/audio`);
            processor.port.onmessage = e => {
                if (audioWS.readyState === WebSocket.OPEN) {
                    audioWS.send(e.data.buffer);           // Float32Array â†’ ArrayBuffer
                }
            };

            source.connect(processor).connect(ctx.destination);
        })();
    </script>
</body>

</html>