<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <!-- <title>Realtime Caption</title> -->
    <style>
        /* ---------- 配色 ---------- */
        body {
            background: #fff;
            color: #000;
            font: 20px/1.6 monospace;
            text-align: center
        }

        #caption {
            margin-top: 30vh;
            font-size: 2.5rem;
            word-break: break-all;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>🎙️ Realtime Caption</h1>
    <div id="caption">(等待麥克風授權…)</div>

    <script>
        (async () => {
            /* --------- 自動執行 --------- */
            const SAMPLE_RATE = 16000;

            /* 1. 連字幕 WebSocket */
            const capWS = new WebSocket(`wss://${location.host}/ws/caption`);
            capWS.onmessage = e => {
                document.getElementById('caption').textContent = e.data || '…';
            };

            /* 2. 取麥克風 */
            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            } catch (err) {
                document.getElementById('caption').textContent = '💥 無法存取麥克風：' + err.message;
                return;
            }

            /* 3. 建立 AudioWorklet → 送音訊 */
            const ctx = new AudioContext();
            await ctx.audioWorklet.addModule('/static/worklet.js');
            const source = ctx.createMediaStreamSource(stream);
            const processor = new AudioWorkletNode(ctx, 'pcm-writer');

            const audioWS = new WebSocket(`wss://${location.host}/ws/audio`);
            processor.port.onmessage = e => {
                if (audioWS.readyState === WebSocket.OPEN) {
                    audioWS.send(e.data.buffer);           // Float32Array → ArrayBuffer
                }
            };

            source.connect(processor).connect(ctx.destination);
        })();
    </script>
</body>

</html>