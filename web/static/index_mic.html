<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <style>
        body {
            background: #fff;
            color: #000;
            font: 20px/1.6 monospace;
            text-align: center;
        }

        #caption {
            margin-top: 30vh;
            font-size: 2.5rem;
            word-break: break-word;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div id="caption">(ç­‰å¾…éº¥å…‹é¢¨æŽˆæ¬Šâ€¦)</div>

    <script>
        const SAMPLE_RATE = 16000;

        // å»ºç«‹è‡ªå‹•é‡é€£ WebSocket
        function createWebSocket(url, onMessage, name = '', onOpenCallback) {
            let ws;

            function connect() {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    console.log(`[WebSocket] ${name} é€£ç·šæˆåŠŸ`);
                    if (onOpenCallback) onOpenCallback(ws);
                };
                ws.onmessage = onMessage;
                ws.onclose = () => {
                    console.warn(`[WebSocket] ${name} ä¸­æ–·ï¼Œ3ç§’å¾Œé‡é€£â€¦`);
                    setTimeout(connect, 3000);
                };
                ws.onerror = () => {
                    ws.close(); // å¼·åˆ¶è§¸ç™¼ onclose
                };
            }

            connect();
            return () => ws.close();
        }

        (async () => {
            // éº¥å…‹é¢¨å­˜å–
            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                document.getElementById('caption').textContent = 'ðŸ’¥ ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼š' + err.message;
                return;
            }

            // å»ºç«‹ AudioContext èˆ‡ AudioWorklet
            const ctx = new AudioContext();
            try {
                await ctx.audioWorklet.addModule('/static/worklet.js');
            } catch (err) {
                document.getElementById('caption').textContent = 'ðŸ’¥ è¼‰å…¥ audio worklet å¤±æ•—ï¼š' + err.message;
                return;
            }

            const source = ctx.createMediaStreamSource(stream);
            const processor = new AudioWorkletNode(ctx, 'pcm-writer');

            let currentAudioWS = null;
            createWebSocket(
                `wss://${location.host}/ws/audio`,
                () => { }, // ç„¡éœ€è™•ç†è¨Šæ¯
                'Audio',
                ws => {
                    currentAudioWS = ws;
                    document.getElementById('caption').textContent = "http://192.168.1.154:8445/";
                }
            );

            processor.port.onmessage = e => {
                if (currentAudioWS && currentAudioWS.readyState === WebSocket.OPEN) {
                    currentAudioWS.send(e.data.buffer);
                }
            };

            source.connect(processor).connect(ctx.destination);
        })();
    </script>
</body>

</html>